#!/bin/sh
#
# We need to be sure pmcd is stable before creating any of the QA
# archives.
#
# In particular any post-install .Need* files have been dealt with
# as these may cause various pmcd state changes that can be reflected
# in <mark> record badness in the archives created by pmlogger.
#

. ${PCP_CONF:-/etc/pcp.conf}

# need this for pmsleep
#
export PATH=$PCP_BINADM_DIR:$PATH

tmp=/var/tmp/check-pmcd-stable-$$
sts=0
trap "rm -f $tmp.*; exit \$sts" 0 1 2 3 15

_check()
{
    find $PCP_PMDAS_DIR -name ".Need*" -print \
    | grep -v '\.sav$'
}

# emasculated version of _service() from ../common.check ...
#
_restart_pmcd()
{
    if which systemctl >/dev/null 2>&1
    then
	sudo systemctl restart pmcd.service
    elif [ -f $PCP_RC_DIR/pmcd ]
    then
	sudo $PCP_RC_DIR/pmcd restart
    else
	echo "_restart_pmcd: pmcd not a systemctl service nor a $PCP_RC_DIR script!"
	sts=1
	exit
    fi
}

_check >$tmp.tmp
if [ -s $tmp.tmp ]
then
    echo "Need to wait while these get fixed: `tr '\012' ' ' <$tmp.tmp`"
    _restart_pmcd
    i=0
    rm -f $tmp.ok
    # give the rc scripts $wait seconds to get going
    #
    wait=10
    iter=`expr $wait \* 10`
    while [ $i -lt $iter ]
    do
	pmsleep 0.1
	_check >$tmp.tmp
	if [ -s $tmp.tmp ]
	then
	    touch $tmp.ok
	    break
	fi
	i=`expr $i + 1`
    done
    if [ -f $tmp.ok ]
    then
	# whack pmcd to be sure, to be sure, ...
	#
	pminfo -v >/dev/null 2>&1
    else
	echo "Failed to fix these after ${iter}secs: `tr '\012' ' ' <$tmp.tmp`"
	sts=1
    fi
fi
