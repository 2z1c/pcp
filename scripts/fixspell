#!/bin/sh
#
# Check spelling in man pages ...
# Typical usage is from vi(1), add a blank line at the
# end of the file, then !!fixspell %<RETURN>
#
# Common PCP exceptions are captured in the sed script at the end of
# this script, and extracted from the .SH SYNOPSIS section (the command
# line option argument names and flags), and from any '\" spell-ok
# line in the file.
#
# Copyright (c) 2024 Ken McDonell, Inc.  All Rights Reserved.
#

tmp=/tmp/fixsa-$$
trap "rm -f $tmp.*; exit" 0 1 2 3 15

if [ $# -ne 1 ]
then
    echo "Usage: fixspell filename"
    exit 1
fi

if [ ! -f "$1" ]
then
    echo "Error: input file $1 not found"
    exit 1
fi

# get lines like this from the .SH SYNOPSIS section
# CLNoPruy from
# [\f3\-CLNoPruy?\f1]
# conffile from
# [\f3\-c\f1 \f2conffile\f1]
#
awk <"$1" '
$1 == ".SH" && $2 == "SYNOPSIS" { want = 1; next }
want == 1 && $1 == ".SH"	{ exit }
want == 1			{ print }' \
| tr ' ' '\012' \
| sed -n >$tmp.tmp \
    -e '/^\\f2/{
s///
s/\\f.*//
p
}' \
    -e '/^\[\\f3\\-[A-Za-z]*?\\f/{
s/^\[\\f3\\-//
s/?.*//
p
}' \
# end

# and for .\" spell-ok lines, all words remaining on the line are
# spelled correctly ...
#
sed -n <"$1" -e 's/^\.\\" spell-ok //p' \
| tr ' ' '\012' >>$tmp.tmp

sed <$tmp.tmp >$tmp.sed \
    -e '/^$/d' \
    -e ' s/.*/\/^&$\/d/' \
# end

# spell sort and remove duplicates, then cull the exceptions from $1
# followed by culling of the globally known exceptions in PCP man page
# land
#
spell "$1" \
| LC_COLLATE=POSIX sort \
| uniq \
| sed -f $tmp.sed \
| sed \
    -e "/^PMCD's$/d" \
    -e '/^CONF$/d' \
    -e '/^Co$/d' \
    -e '/^DIR$/d' \
    -e '/^DSO$/d' \
    -e '/^Gbyte$/d' \
    -e '/^GiB$/d' \
    -e '/^IPC$/d' \
    -e '/^Kbyte$/d' \
    -e '/^KiB$/d' \
    -e '/^Mbyte$/d' \
    -e '/^MiB$/d' \
    -e '/^OK$/d' \
    -e '/^PCP$/d' \
    -e '/^PCPIntro$/d' \
    -e '/^PDU$/d' \
    -e '/^PID$/d' \
    -e '/^PMAPI$/d' \
    -e '/^PMCD$/d' \
    -e '/^PMDAs\?$/d' \
    -e '/^PMLOGGER$/d' \
    -e '/^PMNS$/d' \
    -e '/^RC$/d' \
    -e '/^SIGHUP$/d' \
    -e '/^SIGUSR$/d' \
    -e '/^SYSCONF$/d' \
    -e '/^SYSCONFIG$/d' \
    -e '/^TMP$/d' \
    -e '/^TZ$/d' \
    -e '/^chkconfig$/d' \
    -e '/^conf$/d' \
    -e '/^config$/d' \
    -e '/^endif$/d' \
    -e '/^env$/d' \
    -e '/^foo$/d' \
    -e '/^fread$/d' \
    -e '/^fwrite$/d' \
    -e '/^ifdef$/d' \
    -e '/^ifndef$/d' \
    -e '/^ipc$/d' \
    -e '/^libpcp$/d' \
    -e '/^localhost$/d' \
    -e '/^loopback$/d' \
    -e '/^metacharacters\?$/d' \
    -e '/^mins$/d' \
    -e '/^mins\?$/d' \
    -e '/^msecs\?$/d' \
    -e '/^nfs$/d' \
    -e '/^nsecs\?$/d' \
    -e '/^ok$/d' \
    -e '/^pcp$/d' \
    -e '/^pdu$/d' \
    -e '/^pid$/d' \
    -e '/^pm$/d' \
    -e '/^pmGetInDom$/d' \
    -e '/^pmServerNotifyServiceManagerReady$/d' \
    -e '/^pmSpecLocalPMDA$/d' \
    -e '/^pmcd$/d' \
    -e '/^pmcpp$/d' \
    -e '/^pmdaExtSetFlags$/d' \
    -e '/^pmdammv$/d' \
    -e '/^pmdaopenmetrics$/d' \
    -e '/^pmlc$/d' \
    -e '/^pmlogdump$/d' \
    -e '/^pmlogextract$/d' \
    -e '/^pmlogger$/d' \
    -e '/^secs\?$/d' \
    -e '/^stdmacro$/d' \
    -e '/^strftime$/d' \
    -e '/^systemctl$/d' \
    -e '/^systemd$/d' \
    -e '/^timeunits$/d' \
    -e '/^var$/d' \
# end
