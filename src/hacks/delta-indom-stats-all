#!/bin/sh
#
# Do delta-indom-stats for all the archives you can find under
# the sun.
#

make delta-indom-stats

find ../../qa /var/log/pcp/pmlogger \( -name "*.meta.*" -o -name "*.meta" \) \
| while read arch
do
    case "$arch"
    in
	../../qa/badarchives/*|../../qa/*.full)
	    ;;
	*)
	    delta-indom-stats "$arch" 2>&1
	    ;;
    esac
done >report.full

( sed -n <report.full -e '/Saving/{
p
q
}' \
  ; ( grep Total report.full \
      | sort -nr -k4,4 \
    ) \
) \
| sed -e 's/^.....................//' \
| awk '
BEGIN		{ big = small = 0 }
NR == 1		{ print; next }
$3 > 1024*1024	{ print; big++; next }
small == 0	{ print "More than 1Mb saving for " big " archives" }
		{ small++ }
END		{ print "And less than 1Mb saving for " small " archives" }'

grep '\(no change\)' report.full \
| wc -l \
| sed -e 's/  *//g' -e 's/.*/No change for & archives./'

echo "See report.full for chapter and verse ..."
